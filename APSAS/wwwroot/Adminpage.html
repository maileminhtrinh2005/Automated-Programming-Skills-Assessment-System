<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang Quản Trị (Admin)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 40px;
            color: #333;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
            width: 100%;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
            font-size: 14px;
        }

        input, select {

            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }

        .message {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

            .message.success {
                color: green;
            }

            .message.error {
                color: #c0392b;
            }

        .container-api, .container-user {
            width: 400px;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .container-api button {
                background-color: #3498db;
            }

                .container-api button:hover {
                    background-color: #2980b9;
                }

            .container-user button {
                background: #0066cc;

            }

                .container-user button:hover {
                    background: #0056b3;
                }

        table {
            border-collapse: collapse;
            width: 100%;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #0066cc;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .btn-edit {
            background-color: #27ae60;
            padding: 6px 10px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            border: none;
        }
            .btn-edit:hover {
                background-color: #2ecc71;
            }

        .btn-delete {
            background-color: #c0392b;
            padding: 6px 10px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            border: none;
        }


            .btn-delete:hover {
                background-color: #e74c3c;
            }

        /* Modal edit user */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            width: 420px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

            .modal h3 {
                margin: 0 0 10px 0;
                text-align: center;
            }

            .modal .actions {
                display: flex;
                gap: 10px;
                margin-top: 12px;
            }

        .small {
            width: auto;
            padding: 8px 12px;
        }

        #userTableContainer {
            width: 90%;
            max-width: 1000px;
        }

        #apiListContainer {
            margin-top: 15px;
        }

        .logout {
            position: fixed;
            top: 20px;
            right: 40px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

            .logout:hover {
                background: #a71d2a;
            }
    </style>
</head>
<body>
    <h1>Trang Quản Trị</h1>

    <!-- ========== PHẦN API CONFIG ========== -->
    <div class="container-api" id="apiContainer">
        <h2>Quản Lý API</h2>
        <div id="addApiForm">
            <label for="apiName">Tên API:</label>
            <input type="text" id="apiName" placeholder="VD: Judge0">
            <label for="baseUrl">Base URL:</label>
            <input type="text" id="baseUrl" placeholder="VD: https://api.judge0.com">
            <button onclick="addAPIConfig()">Thêm API</button>
            <button onclick="toggleApiForm('update')" style="background-color:#27ae60;">Cập nhật API</button>
            <button onclick="toggleApiForm('list')" style="background-color:#8e44ad;">Xem danh sách API</button>
            <div id="apiMessage" class="message"></div>
        </div>

        <div id="updateApiForm" style="display:none;">
            <label for="apiId">API ID:</label>
            <input type="number" id="apiId">
            <label for="apiNameUpdate">Tên API mới:</label>
            <input type="text" id="apiNameUpdate">
            <label for="baseUrlUpdate">Base URL mới:</label>
            <input type="text" id="baseUrlUpdate">
            <button onclick="updateAPIConfig()" style="background-color:#27ae60;">Cập nhật API</button>
            <button onclick="toggleApiForm('add')" style="background-color:#3498db;">Quay lại Thêm API</button>
            <div id="apiUpdateMessage" class="message"></div>
        </div>

        <div id="apiListContainer" style="display:none;">
            <h3>Danh sách API hiện có</h3>
            <div id="apiListContent"></div>
            <button onclick="toggleApiForm('add')"
                    style="margin-top:10px; background-color:#3498db; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;"
                    onmouseover="this.style.backgroundColor='#2980b9'"
                    onmouseout="this.style.backgroundColor='#3498db'">
                Quay lại Thêm API
            </button>
        </div>
    </div>

    <!-- ========== PHẦN USER ========== -->
    <div class="container-user">
        <h2>Thêm Người Dùng</h2>
        <label for="username">Username</label>
        <input id="username" type="text" />
        <label for="email">Email</label>
        <input id="email" type="email" />
        <label for="fullname">Full Name</label>
        <input id="fullname" type="text" />
        <label for="password">Password</label>
        <input id="password" type="password" />
        <label for="roleid">Role</label>
        <select id="roleid">
            <option value="1">1 - Admin</option>
            <option value="2">2 - Giảng viên</option>
            <option value="3">3 - Sinh viên</option>
        </select>
        <button id="submitUserBtn">Thêm User</button>
        <p id="userMessage" class="message"></p>
    </div>

    <h2>Danh Sách Người Dùng</h2>
    <div id="userTableContainer"></div>


    <!-- Edit User Modal -->
    <div id="editOverlay" class="modal-overlay">
        <div class="modal">
            <h3>✏️ Sửa Người Dùng</h3>
            <input type="hidden" id="editUserId" />
            <label>Username</label>
            <input id="editUsername" type="text" />
            <label>Email</label>
            <input id="editEmail" type="email" />
            <label>Full Name</label>
            <input id="editFullname" type="text" />
            <label>Password mới (để trống nếu không đổi)</label>
            <input id="editPassword" type="password" />
            <label>Role</label>
            <select id="editRole">
                <option value="1">1 - Admin</option>
                <option value="2">2 - Giảng viên</option>
                <option value="3">3 - Sinh viên</option>
            </select>
            <div class="actions">
                <button class="small" style="background-color:#27ae60;" onclick="confirmUpdateUser()">Cập nhật</button>
                <button class="small" style="background-color:#c0392b;" onclick="confirmDeleteFromModal()">Xóa</button>
                <button class="small" style="background-color:#7f8c8d;" onclick="closeEditModal()">Hủy</button>
            </div>
            <p id="editMessage" class="message"></p>
        </div>
    </div>

    <script>
        const GATEWAY_URL = "http://localhost:5261";
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");
        window._usersMap = {};

        // Phân quyền JWT
        if (!token || role !== "Admin") {
            alert("🚫 Bạn không có quyền truy cập!");
            localStorage.clear();
            window.location.href = "DN.html";
        }

        async function secureFetch(url, options = {}) {
            options.headers = { ...(options.headers || {}), "Content-Type": "application/json", "Authorization": `Bearer ${token}` };
            return await fetch(url, options);
        }

        function logout() { localStorage.clear(); window.location.href = "DN.html"; }

        // ========== API CONFIG ==========
        function toggleApiForm(mode) {
            document.getElementById("addApiForm").style.display = mode === 'add' ? 'block' : 'none';
            document.getElementById("updateApiForm").style.display = mode === 'update' ? 'block' : 'none';
            document.getElementById("apiListContainer").style.display = mode === 'list' ? 'block' : 'none';
            if (mode === 'list') loadAPIList();
        }

        async function addAPIConfig() {
            const name = document.getElementById("apiName").value.trim();
            const baseUrl = document.getElementById("baseUrl").value.trim();
            const msg = document.getElementById("apiMessage");
            if (!name || !baseUrl) { msg.textContent = "⚠️ Vui lòng nhập đủ thông tin"; msg.className = "message error"; return; }
            try {
                const res = await secureFetch(`${GATEWAY_URL}/AddAPI`, { method: "POST", body: JSON.stringify({ name, baseUrl }) });
                if (!res.ok) throw new Error("Thêm API thất bại");
                msg.textContent = "✅ Thêm API thành công"; msg.className = "message success";
                document.getElementById("apiName").value = ""; document.getElementById("baseUrl").value = "";
            } catch (err) { msg.textContent = "🚫 " + err.message; msg.className = "message error"; }
        }

        async function updateAPIConfig() {
            const id = document.getElementById("apiId").value.trim();
            const name = document.getElementById("apiNameUpdate").value.trim();
            const baseUrl = document.getElementById("baseUrlUpdate").value.trim();
            const msg = document.getElementById("apiUpdateMessage");
            if (!id || !name || !baseUrl) { msg.textContent = "⚠️ Vui lòng nhập đủ thông tin"; msg.className = "message error"; return; }
            try {
                const res = await secureFetch(`${GATEWAY_URL}/UpdateAPI/${id}`, { method: "PUT", body: JSON.stringify({ name, baseUrl }) });
                if (!res.ok) throw new Error("Cập nhật API thất bại");
                msg.textContent = "✅ Cập nhật API thành công"; msg.className = "message success";
            } catch (err) { msg.textContent = "🚫 " + err.message; msg.className = "message error"; }
        }

        async function loadAPIList() {
            const container = document.getElementById("apiListContent");
            container.innerHTML = "<p>⏳ Đang tải API...</p>";
            try {
                const res = await secureFetch(`${GATEWAY_URL}/GetAllAPI`);
                if (!res.ok) throw new Error("Không thể tải API");
                const apis = await res.json();
                if (!apis.length) { container.innerHTML = "<p>Không có API nào.</p>"; return; }
                let html = "<table><tr><th>ID</th><th>Tên API</th><th>Base URL</th></tr>";
                apis.forEach(api => { html += `<tr><td>${api.apiID}</td><td>${api.name}</td><td>${api.baseURL}</td></tr>`; });
                html += "</table>"; container.innerHTML = html;
            } catch (err) { container.innerHTML = `<p style="color:red;">🚫 ${err.message}</p>`; }
        }

        // ========== USERS ==========
        document.getElementById("submitUserBtn").addEventListener("click", async () => {
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const fullname = document.getElementById("fullname").value.trim();
            const password = document.getElementById("password").value.trim();
            const roleid = parseInt(document.getElementById("roleid").value);
            const msg = document.getElementById("userMessage");
            if (!username || !email || !password) { msg.textContent = "⚠️ Vui lòng nhập đủ thông tin!"; msg.className = "message error"; return; }
            try {
                const res = await secureFetch(`${GATEWAY_URL}/AddUser`, { method: "POST", body: JSON.stringify({ username, email, fullName: fullname, passwordHash: password, roleID: roleid }) });
                if (!res.ok) throw new Error("Thêm user thất bại");
                msg.textContent = "✅ Thêm người dùng thành công!"; msg.className = "message success";
                document.getElementById("username").value = ""; document.getElementById("email").value = ""; document.getElementById("fullname").value = ""; document.getElementById("password").value = "";
                loadUsers();
            } catch (err) { msg.textContent = "🚫 " + err.message; msg.className = "message error"; }
        });

        async function loadUsers() {
            const container = document.getElementById("userTableContainer");
            container.innerHTML = "<p>⏳ Đang tải danh sách người dùng...</p>";
            window._usersMap = {};
            try {
                const res = await secureFetch(`${GATEWAY_URL}/GetAllUsers`);
                if (!res.ok) throw new Error("Không thể tải người dùng");
                const users = await res.json();
                users.forEach(u => { window._usersMap[u.userID] = u; });
                let html = "<table><tr><th>ID</th><th>Username</th><th>Email</th><th>Full Name</th><th>Role</th><th>Actions</th></tr>";
                users.forEach(u => {
                    html += `<tr>
                                <td>${u.userID}</td>
                                <td>${u.username}</td>
                                <td>${u.email || ''}</td>
                                <td>${u.fullName || ''}</td>
                                <td>${u.roleName || u.roleID || ''}</td>
                                <td><button class="btn-edit" onclick="openEditModal(${u.userID})">Sửa</button> <button class="btn-delete" onclick="deleteUser(${u.userID})">Xóa</button></td>
                            </tr>`;
                });
                html += "</table>"; container.innerHTML = html;
            } catch (err) { container.innerHTML = `<p style="color:red;">🚫 ${err.message}</p>`; }
        }

        function openEditModal(userId) {
            const user = window._usersMap[userId];
            if (!user) { alert("Không tìm thấy user."); return; }
            document.getElementById("editUserId").value = user.userID;
            document.getElementById("editUsername").value = user.username || "";
            document.getElementById("editEmail").value = user.email || "";
            document.getElementById("editFullname").value = user.fullName || "";
            document.getElementById("editPassword").value = "";
            document.getElementById("editRole").value = user.roleID || 3;
            document.getElementById("editMessage").textContent = "";
            document.getElementById("editOverlay").style.display = "flex";
        }

        function closeEditModal() { document.getElementById("editOverlay").style.display = "none"; }

        async function confirmUpdateUser() {
            const id = parseInt(document.getElementById("editUserId").value);
            const username = document.getElementById("editUsername").value.trim();
            const email = document.getElementById("editEmail").value.trim();
            const fullName = document.getElementById("editFullname").value.trim();
            const password = document.getElementById("editPassword").value.trim();
            const roleID = parseInt(document.getElementById("editRole").value);
            const msg = document.getElementById("editMessage");
            if (!username || !email) { msg.textContent = "⚠️ Username và Email không được để trống."; msg.className = "message error"; return; }
            const payload = { userID: id, username, email, fullName, roleID }; if (password) payload.passwordHash = password;
            try {
                const res = await secureFetch(`${GATEWAY_URL}/UpdateUser`, { method: "PUT", body: JSON.stringify(payload) });
                if (!res.ok) throw new Error("Cập nhật user thất bại");
                msg.textContent = "✅ Cập nhật thành công"; msg.className = "message success";
                loadUsers(); setTimeout(closeEditModal, 1000);
            } catch (err) { msg.textContent = "🚫 " + err.message; msg.className = "message error"; }
        }

        async function deleteUser(userId) {
            if (!confirm("Bạn chắc chắn muốn xóa người dùng này?")) return;
            try {
                const res = await secureFetch(`${GATEWAY_URL}/DeleteUser/${userId}`, { method: "DELETE" });
                if (!res.ok) throw new Error("Xóa thất bại");
                loadUsers();
            } catch (err) { alert("🚫 " + err.message); }
        }

        function confirmDeleteFromModal() {
            const id = parseInt(document.getElementById("editUserId").value);
            deleteUser(id); closeEditModal();
        }

        window.onload = () => { toggleApiForm('add'); loadUsers(); }
    </script>
</body>
</html>