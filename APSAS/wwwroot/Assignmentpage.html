<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>🧪 Thêm TestCase</title>
</head>
<body>
    <h2>Thêm TestCase cho Bài tập</h2>

    <h2>Thêm Bài Tập Mới</h2>
    <form id="addAssignmentForm">
        <label for="title">Tiêu đề:</label>
        <input type="text" id="title" required>

        <label for="description">Mô tả:</label>
        <textarea id="description" rows="3" required></textarea>

        <label for="deadline">Hạn nộp:</label>
        <input type="date" id="deadline" required>

        <label for="difficulty">Độ khó:</label>
        <select id="difficulty">
            <option value="Easy">Dễ</option>
            <option value="Medium">Trung bình</option>
            <option value="Hard">Khó</option>
        </select>
        <label for="weight">Trọng số (weight):</label>
        <input type="number" id="weight" step="0.1" value="1" required>

        <button type="submit">Thêm Bài Tập</button>
    </form>
        <label>Chọn bài tập:</label>
        <select id="assignmentSelect"></select>

        <h3>Danh sách TestCase</h3>
        <table id="testcaseTable">
            <thead>
                <tr>
                    <th>Input</th>
                    <th>Expected Output</th>
                    <th>Weight</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="addRowBtn">+ Thêm dòng</button><br>
        <button id="submitBtn">📤 Gửi TestCases</button>

        <pre id="result"></pre>

        <script>
            const baseUrl = "http://localhost:5261";

            // 🔹 Lấy tất cả bài tập để đưa vào dropdown
            async function loadAssignments() {
                const res = await fetch(`${baseUrl}/GetAllAssignment`);
                const data = await res.json();
                const select = document.getElementById("assignmentSelect");
                data.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.assignmentId;
                    opt.textContent = `${a.assignmentId} - ${a.title}`;
                    select.appendChild(opt);
                });
            }

            // 🔹 Thêm 1 dòng testcase mới
            document.getElementById("addRowBtn").addEventListener("click", () => {
                const tbody = document.querySelector("#testcaseTable tbody");
                const row = document.createElement("tr");

                row.innerHTML = `
                            <td><input type="text" placeholder="Ví dụ: 1 2"></td>
                            <td><input type="text" placeholder="Ví dụ: 3"></td>
                            <td><input type="number" step="0.1" value="1"></td>
                            <td><button class="removeBtn">❌</button></td>
                        `;

                row.querySelector(".removeBtn").addEventListener("click", () => row.remove());
                tbody.appendChild(row);
            });

            // 🔹 Gửi toàn bộ testcase
            document.getElementById("submitBtn").addEventListener("click", async () => {
                const assignmentId = document.getElementById("assignmentSelect").value;
                const rows = document.querySelectorAll("#testcaseTable tbody tr");

                const testCaseItems = Array.from(rows).map(r => ({
                    input: r.children[0].querySelector("input").value,
                    expectedOutput: r.children[1].querySelector("input").value,
                    weight: parseFloat(r.children[2].querySelector("input").value)
                }));

                const payload = {
                    assiginmentId: parseInt(assignmentId),
                    testCaseItems: testCaseItems
                };

                const res = await fetch(`${baseUrl}/AddTestCase`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const text = await res.text();
                document.getElementById("result").textContent = res.ok ? `✅ ${text}` : `❌ ${text}`;
            });

            // adđ assignment
            document.getElementById("addAssignmentForm").addEventListener("submit", async function (event) {
                event.preventDefault();

                const data = {
                    title: document.getElementById("title").value,
                    description: document.getElementById("description").value,
                    deadline: document.getElementById("deadline").value,
                    difficulty: document.getElementById("difficulty").value,
                    weight: parseFloat(document.getElementById("weight").value)
                };

                const response = await fetch(`${baseUrl}/AddAssignment`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("✅ Thêm bài tập thành công!");
                } else {
                    alert("❌ Thêm bài tập thất bại!");
                }
            });

            loadAssignments(); // gọi khi trang mở
        </script>
</body>
</html>
