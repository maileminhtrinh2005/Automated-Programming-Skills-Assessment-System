<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>🧪 Quản lý Bài tập</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .hidden {
            display: none;
        }

        form, table, select, button {
            margin: 10px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: #eee;
        }
    </style>
</head>
<body>
    <h2 id="pageTitle">Quản lý Bài tập</h2>

    <!-- 🔹 Form thêm bài tập (ẩn với học sinh) -->
    <div id="teacherSection">
        <h3>Thêm Bài Tập Mới</h3>
        <form id="addAssignmentForm">
            <label for="title">Tiêu đề:</label>
            <input type="text" id="title" required>

            <label for="description">Mô tả:</label>
            <textarea id="description" rows="3" required></textarea>

            <label for="deadline">Hạn nộp:</label>
            <input type="date" id="deadline" required>

            <label for="difficulty">Độ khó:</label>
            <select id="difficulty">
                <option value="Easy">Dễ</option>
                <option value="Medium">Trung bình</option>
                <option value="Hard">Khó</option>
            </select>

            <label for="weight">Trọng số (weight):</label>
            <input type="number" id="weight" step="0.1" value="1" required>

            <button type="submit">➕ Thêm Bài Tập</button>
        </form>
    </div>

    <!-- 🔹 Phần chọn bài tập -->
    <div id="assignmentSection">
        <label>Chọn bài tập:</label>
        <select id="assignmentSelect"></select>
    </div>

    <!-- 🔹 Danh sách test case (ẩn với học sinh) -->
    <div id="testcaseSection">
        <h3>Danh sách TestCase</h3>
        <table id="testcaseTable">
            <thead>
                <tr>
                    <th>Input</th>
                    <th>Expected Output</th>
                    <th>Weight</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="addRowBtn">+ Thêm dòng</button><br>
        <button id="submitBtn">📤 Gửi TestCases</button>
    </div>

    <pre id="result"></pre>

    <script>
        const baseUrl = "http://localhost:5261";

        // 🔹 Giả lập role (tạm set cứng)
        const role = "Student"; // 👉 đổi sang "Teacher" để test chức năng giáo viên
        //const role = "Teacher";

        // 🔹 Ẩn hiện các phần theo role
        function setupUIByRole() {
            const teacherSection = document.getElementById("teacherSection");
            const testcaseSection = document.getElementById("testcaseSection");

            if (role === "Teacher") {
                teacherSection.classList.remove("hidden");
                testcaseSection.classList.remove("hidden");
                document.getElementById("pageTitle").textContent = "👨‍🏫 Quản lý Bài tập (Giáo viên)";
            } else {
                teacherSection.classList.add("hidden");
                testcaseSection.classList.add("hidden");
                document.getElementById("pageTitle").textContent = "👩‍🎓 Danh sách Bài tập (Học sinh)";
            }
        }

        // 🔹 Load danh sách bài tập
        async function loadAssignments() {
            const res = await fetch(`${baseUrl}/GetAllAssignment`);
            const data = await res.json();
            const select = document.getElementById("assignmentSelect");

            data.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.assignmentId;
                opt.textContent = `${a.assignmentId} - ${a.title}`;
                select.appendChild(opt);
            });

            // Nếu là học sinh → bấm chọn bài tập để xem chi tiết
            if (role === "Student") {
                select.addEventListener("change", () => {
                    const selectedId = select.value;
                    if (selectedId) {
                        // Lưu ID vào localStorage
                        localStorage.setItem("selectedAssignmentId", selectedId);
                        // Chuyển qua trang xem bài tập
                        window.location.href = `SubmissionPage.html?id=${selectedId}`;

                    }
                });
            }
        }

        // 🔹 Thêm dòng TestCase (chỉ dành cho giáo viên)
        document.getElementById("addRowBtn").addEventListener("click", () => {
            const tbody = document.querySelector("#testcaseTable tbody");
            const row = document.createElement("tr");

            row.innerHTML = `
        <td><textarea placeholder="Ví dụ: 1 2 hoặc 1↵2" rows="2" style="width:100%;"></textarea></td>
        <td><textarea placeholder="Ví dụ: 3" rows="1" style="width:100%;"></textarea></td>
        <td><input type="number" step="0.1" value="1" style="width:60px;"></td>
        <td><button class="removeBtn">❌</button></td>
    `;
            row.querySelector(".removeBtn").addEventListener("click", () => row.remove());
            tbody.appendChild(row);
        });

        // 🔹 Gửi TestCase
        document.getElementById("submitBtn").addEventListener("click", async () => {
            const assignmentId = document.getElementById("assignmentSelect").value;
            const rows = document.querySelectorAll("#testcaseTable tbody tr");

            const testCaseItems = Array.from(rows).map(r => ({
                input: r.children[0].querySelector("textarea").value.trim(),
                expectedOutput: r.children[1].querySelector("textarea").value.trim(),
                weight: parseFloat(r.children[2].querySelector("input").value)
            }));


            const payload = {
                assiginmentId: parseInt(assignmentId),
                testCaseItems: testCaseItems
            };

            const res = await fetch(`${baseUrl}/AddTestCase`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const text = await res.text();
            document.getElementById("result").textContent = res.ok ? `✅ ${text}` : `❌ ${text}`;
        });

        // 🔹 Thêm bài tập (chỉ giáo viên dùng)
        document.getElementById("addAssignmentForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const data = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                deadline: document.getElementById("deadline").value,
                difficulty: document.getElementById("difficulty").value,
                weight: parseFloat(document.getElementById("weight").value)
            };

            const res = await fetch(`${baseUrl}/AddAssignment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert("✅ Thêm bài tập thành công!");
                loadAssignments(); // reload list
            } else {
                alert("❌ Thêm bài tập thất bại!");
            }
        });

        // 🔹 Gọi khi trang mở
        setupUIByRole();
        loadAssignments();
    </script>
</body>
</html>
