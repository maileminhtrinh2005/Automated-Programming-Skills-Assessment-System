<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>APSAS - User Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            width: 360px;
            margin: 20px auto;
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        h2 {
            text-align: center;
            margin-bottom: 12px;
        }

        label {
            font-size: 13px;
            display: block;
            margin-top: 8px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #d1d7de;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            margin-top: 14px;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #0066cc;
            color: #fff;
            cursor: pointer;
        }

            button:disabled {
                opacity: .6;
                cursor: not-allowed;
            }

        .msg {
            margin-top: 12px;
            font-size: 14px;
        }

            .msg.success {
                color: green;
            }

            .msg.error {
                color: #c0392b;
            }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
    </style>
</head>
<body>

    <!-- ADD USER -->
    <div class="card" id="addCard">
        <h2>Thêm người dùng (Add User)</h2>

        <label for="username">Username</label>
        <input id="username" type="text" placeholder="username" />

        <label for="email">Email</label>
        <input id="email" type="email" placeholder="user@example.com" />

        <label for="fullname">Full Name</label>
        <input id="fullname" type="text" placeholder="Nguyen Van A" />

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Mật khẩu người dùng" />

        <div class="hint">
            Trường gửi lên là <code>PasswordHash</code> (server sẽ mã hóa nếu bạn thêm hash bên server).
        </div>

        <button id="submitBtn">Thêm user</button>
        <p id="message" class="msg"></p>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
        <h2>Đăng nhập (Login)</h2>

        <label for="loginUsername">Username</label>
        <input id="loginUsername" type="text" placeholder="username" />

        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="password" />

        <button id="loginBtn">Đăng nhập</button>

        <p id="loginMessage" class="msg"></p>
    </div>

    <script>
        const gatewayUrl = "http://localhost:5261"; // Ocelot Gateway URL
        const addUserEndpoint = "/AddUser";
        const loginEndpoint = "/Login";
        const getUsersEndpoint = "/GetAllUsers";
        const deleteEndpoint = "/DeleteUser"; // 🧩 (sẽ thêm ở backend sau)
        const updateEndpoint = "/UpdateUser"; // 🧩 (sẽ thêm ở backend sau)

        const $ = id => document.getElementById(id);

        // ================== UI MESSAGE ==================
        function showMessage(el, text, kind = "info") {
            el.textContent = text;
            el.className = "msg " + (kind === "success" ? "success" : kind === "error" ? "error" : "");
        }

        // ================== ADD USER ==================
        const submitBtn = $("submitBtn");
        const msg = $("message");

        submitBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            showMessage(msg, "");

            const Username = $("username").value.trim();
            const Email = $("email").value.trim();
            const FullName = $("fullname").value.trim();
            const PasswordHash = $("password").value;

            if (!Username || !Email || !PasswordHash) {
                showMessage(msg, "⚠️ Vui lòng điền đủ username, email và password.", "error");
                return;
            }

            const body = { Username, Email, FullName, PasswordHash };
            submitBtn.disabled = true;
            submitBtn.textContent = "Đang gửi...";

            try {
                const res = await fetch(gatewayUrl + addUserEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error(await res.text());
                showMessage(msg, "✅ Thêm user thành công!", "success");
                $("username").value = $("email").value = $("fullname").value = $("password").value = "";
                loadUsers(); // reload lại bảng
            } catch (err) {
                showMessage(msg, "❌ " + err.message, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Thêm user";
            }
        });
        // ================= Login =================
        const loginBtn = $("loginBtn");
        const loginMsg = $("loginMessage");

        loginBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            showMessage(loginMsg, "");

            const Username = $("loginUsername").value.trim();
            const PasswordHash = $("loginPassword").value;

            if (!Username || !PasswordHash) {
                showMessage(loginMsg, "⚠️ Vui lòng nhập username và password.", "error");
                return;
            }

            const body = { Username, PasswordHash };

            loginBtn.disabled = true;
            loginBtn.textContent = "Đang đăng nhập...";

            try {
                const res = await fetch(gatewayUrl + loginEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const text = await res.text();
                if (!res.ok) throw new Error(text || `Lỗi: ${res.status}`);

                const data = JSON.parse(text);
                showMessage(loginMsg, `✅ ${data.message || "Đăng nhập thành công!"}`, "success");
            } catch (err) {
                console.error(err);
                showMessage(loginMsg, "❌ " + err.message, "error");
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Đăng nhập";
            }
        });

        // ================== LOAD USERS ==================
        async function loadUsers() {
            try {
                const res = await fetch(gatewayUrl + getUsersEndpoint);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const users = await res.json();
                renderTable(users);
            } catch (err) {
                console.error(err);
                alert("Lỗi khi tải danh sách người dùng: " + err.message);
            }
        }

        // ================== RENDER TABLE (CÓ PASSWORD) ==================
        function renderTable(users) {
            const container = document.getElementById("userTableContainer");
            container.innerHTML = `
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Password (Nhập nếu muốn đổi)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(u => `
                    <tr>
                        <td>${u.userID}</td>
                        <td contenteditable="true" data-field="username">${u.username}</td>
                        <td contenteditable="true" data-field="email">${u.email}</td>
                        <td contenteditable="true" data-field="fullName">${u.fullName}</td>
                        <td>
                            <input type="password" data-field="passwordHash" placeholder="••••••" style="width:120px; border:1px solid #ddd; border-radius:4px; padding:4px 6px;">
                        </td>
                        <td>
                            <button class="btn-edit" onclick="updateUser(${u.userID}, this)">💾 Lưu</button>
                            <button class="btn-delete" onclick="deleteUser(${u.userID})">🗑 Xóa</button>
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;
        }


        // ================== DELETE USER ==================
        async function deleteUser(id) {
            if (!confirm("Bạn có chắc muốn xóa người dùng này không?")) return;
            try {
                const res = await fetch(`${gatewayUrl}${deleteEndpoint}/${id}`, { method: "DELETE" });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                alert("✅ Xóa thành công!");
                loadUsers();
            } catch (err) {
                alert("❌ Lỗi khi xóa: " + err.message);
            }
        }

        // ================== UPDATE USER (CÓ PASSWORD) ==================
        async function updateUser(id, btn) {
            const row = btn.closest("tr");
            const updatedUser = {
                UserID: id,
                Username: row.querySelector('[data-field="username"]').textContent.trim(),
                Email: row.querySelector('[data-field="email"]').textContent.trim(),
                FullName: row.querySelector('[data-field="fullName"]').textContent.trim(),
                PasswordHash: row.querySelector('[data-field="passwordHash"]').value.trim() // ✅ thêm password
            };

            try {
                const res = await fetch(gatewayUrl + updateEndpoint, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedUser)
                });

                if (!res.ok) throw new Error(await res.text());

                alert("✅ Cập nhật thành công!");
                loadUsers(); // reload bảng sau khi lưu
            } catch (err) {
                alert("❌ Lỗi khi cập nhật: " + err.message);
            }
        }



        window.deleteUser = deleteUser;
        window.updateUser = updateUser;

        // Load bảng khi trang mở
        loadUsers();
    </script>

    <style>
        .user-table input[type="password"] {
            width: 100%;
            padding: 5px 6px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .user-table {
            border-collapse: collapse;
            width: 90%;
            margin-top: 30px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

            .user-table th, .user-table td {
                border: 1px solid #ddd;
                padding: 10px 15px;
                text-align: left;
            }

            .user-table th {
                background-color: #0066cc;
                color: white;
            }

            .user-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }

        .btn-edit, .btn-delete {
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            margin-right: 4px;
        }

        .btn-edit {
            background-color: #27ae60;
        }

        .btn-delete {
            background-color: #c0392b;
        }

        .btn-edit:hover {
            background-color: #2ecc71;
        }

        .btn-delete:hover {
            background-color: #e74c3c;
        }
    </style>

    <div id="userTableContainer"></div>

</body>
</html>
