<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bell Notifications (SignalR)</title>
    <!-- SignalR client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --bg: #0b1220;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --panel: #0f172a;
            --line: #1f2937;
            --accent: #60a5fa;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 500 15px/1.5 system-ui,Segoe UI,Roboto,Arial
        }

        .topbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--line);
            background: #0d1526
        }

        .bell {
            position: relative;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: #0b1220
        }

        .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 999px;
            background: var(--accent);
            color: #001428;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px
        }

        .panel {
            position: absolute;
            right: 10px;
            top: 56px;
            width: 360px;
            max-height: 60vh;
            overflow: auto;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,.35);
            display: none
        }

            .panel.open {
                display: block
            }

        .hd {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

            .hd small {
                color: var(--muted)
            }

        .list {
            list-style: none;
            margin: 0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .item {
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px;
            background: #0b1220
        }

            .item b {
                display: block;
                margin-bottom: 4px
            }

        .empty {
            padding: 16px;
            color: var(--muted);
            text-align: center
        }

        .wrap {
            max-width: 900px;
            margin: 22px auto;
            padding: 0 14px;
            color: var(--muted)
        }

        code {
            background: #0b1220;
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 2px 6px
        }

        .row {
            display: flex;
            gap: 6px;
            align-items: center
        }

        .link {
            color: var(--accent);
            text-decoration: none
        }

            .link:hover {
                text-decoration: underline
            }
    </style>
</head>
<body>
    <div class="topbar">
        <div id="bell" class="bell" aria-label="Thông báo" title="Thông báo">
            <!-- SVG chuông -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3a6 6 0 0 0-6 6v3.59l-.71.7A1 1 0 0 0 6 15h12a1 1 0 0 0 .71-1.71l-.71-.7V9a6 6 0 0 0-6-6Z" stroke="#cbd5e1" stroke-width="1.7" />
                <path d="M9 18c.6 1.2 1.8 2 3 2s2.4-.8 3-2" stroke="#cbd5e1" stroke-width="1.7" stroke-linecap="round" />
            </svg>
            <span id="badge" class="badge" style="display:none">0</span>
        </div>

        <div id="panel" class="panel" role="dialog" aria-label="Danh sách thông báo">
            <div class="hd">
                <b>Thông báo</b>
                <small><span id="state">Đang kết nối…</span></small>
            </div>
            <ul id="list" class="list"></ul>
            <div id="empty" class="empty">Chưa có thông báo</div>
        </div>
    </div>

    <div class="wrap">
        <p>Trang này chỉ <b>nhận</b> tin nhắn từ SignalR (NotificationService) qua <b>API Gateway</b>.</p>
        <div class="row">
            <span>Hub:</span>
            <code id="hubUrlShow">http://localhost:5261/notificationsHub</code>
            <a class="link" href="#" id="reconnect">Kết nối lại</a>
        </div>
    </div>

    <script>
        // ==== CẤU HÌNH: ĐỔI THEO GATEWAY CỦA BẠN ====
        const HUB_URL = "http://localhost:5261/notificationsHub"; // Upstream qua Gateway

        // ==== UI ====
        const bell = document.getElementById('bell');
        const badge = document.getElementById('badge');
        const panel = document.getElementById('panel');
        const list = document.getElementById('list');
        const empty = document.getElementById('empty');
        const state = document.getElementById('state');
        const hubUrlShow = document.getElementById('hubUrlShow');
        const reconnect = document.getElementById('reconnect');
        hubUrlShow.textContent = HUB_URL;

        let unread = 0;
        function setBadge(n) {
            unread = n;
            if (n > 0) { badge.style.display = 'flex'; badge.textContent = n > 99 ? '99+' : n; }
            else { badge.style.display = 'none'; badge.textContent = '0'; }
        }
        function togglePanel() {
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) setBadge(0);
        }
        bell.addEventListener('click', togglePanel);
        reconnect.addEventListener('click', (e) => { e.preventDefault(); connect(true); });

        function addItem(dto) {
            const id = dto.id || dto.notificationId || '';
            const title = dto.title || '(Không tiêu đề)';
            const msg = dto.message || dto.content || '';
            const created = dto.createdAtUtc || dto.createdAt || new Date().toISOString();

            const li = document.createElement('li');
            li.className = 'item';
            li.innerHTML = `<b>${escapeHtml(title)}</b>
                          <div>${escapeHtml(msg)}</div>
                          <small>ID: <code>${escapeHtml(id)}</code> • ${escapeHtml(created)}</small>`;
            list.prepend(li);
            empty.style.display = 'none';
            if (!panel.classList.contains('open')) setBadge(unread + 1);
        }
        function escapeHtml(s) {
            return String(s).replace(/[&<>\"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', '\\'':' &#39; '}[m]));}

        // ==== SIGNALR ====
        let connection;
                async function connect(force = false){
                try{
                    state.textContent = 'Đang kết nối…';
                    if(force && connection){ try { await connection.stop(); } catch { } }

            connection = new signalR.HubConnectionBuilder()
                .withUrl(HUB_URL, { withCredentials: true }) // Gateway nên bật CORS + credentials nếu khác origin
                .withAutomaticReconnect()
                .build();

            connection.on('NotifyNew', addItem);
            connection.onreconnecting(() => state.textContent = 'Mất kết nối, đang thử lại…');
            connection.onreconnected(() => state.textContent = 'Đã kết nối');
            connection.onclose(() => state.textContent = 'Đã đóng kết nối');

            await connection.start();
            state.textContent = 'Đã kết nối';
        } catch (e) {
            console.error(e);
            state.textContent = 'Lỗi kết nối (kiểm tra Gateway route / WebSocket)';
            // Thử lại sau 2 giây
            setTimeout(() => connect(), 2000);
        }
        
        connect();
    </script>
</body>
</html>
